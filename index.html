<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>Anonim Chat</title>
  <script>
    let user = null;

    function onTelegramAuth(userData) {
      // Foydalanuvchini serverga yuboramiz
      fetch("http://localhost:8000/api/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(userData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          user = data.user;
          document.getElementById("telegram-login").style.display = "none";
          document.getElementById("chat-form").style.display = "block";
        } else {
          alert("Login xato");
        }
      });
    }

    function sendMessage() {
      const text = document.getElementById("message").value;
      if (!text || !user) return;

      fetch("http://localhost:8000/api/message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, user })
      }).then(res => res.json())
        .then(data => {
          if (data.ok) {
            alert("Xabar yuborildi!");
            document.getElementById("message").value = "";
          } else {
            alert("Xabar yuborilmadi");
          }
        });
    }
  </script>
</head>
<body style="font-family:sans-serif;text-align:center;padding:40px">
  <h2>Anonim xabar yuborish</h2>

  <!-- Telegram Login Widget -->
  <div id="telegram-login">
    <script async src="https://telegram.org/js/telegram-widget.js?7"
      data-telegram-login="AnonimWebChatbot"
      data-size="large"
      data-userpic="false"
      data-request-access="write"
      data-onauth="onTelegramAuth(user)"
      data-lang="uz">
    </script>
  </div>

  <!-- Xabar yuborish formasi -->
  <div id="chat-form" style="display:none;margin-top:20px">
    <textarea id="message" rows="4" cols="40" placeholder="Xabaringizni yozing..."></textarea><br><br>
    <button onclick="sendMessage()">Yuborish</button>
  </div>
</body>
</html>
